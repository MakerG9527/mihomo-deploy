#!/bin/bash
# Mihomo 订阅管理脚本
# 用于下载、转换和管理订阅配置

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# 日志函数
log() { echo -e "${GREEN}[✓]${NC} $*"; }
info() { echo -e "${BLUE}[ℹ]${NC} $*"; }
warn() { echo -e "${YELLOW}[!]${NC} $*"; }
err() { echo -e "${RED}[✗]${NC} $*" >&2; }
banner() {
    echo ""
    echo "========================================"
    echo "  $*"
    echo "========================================"
    echo ""
}

# 配置路径
CONFIG_DIR="${CONFIG_DIR:-/etc/mihomo}"
CONFIG_FILE="$CONFIG_DIR/config.yaml"
SUB_FILE="$CONFIG_DIR/subscription.url"
BACKUP_DIR="$CONFIG_DIR/backups"
PROVIDERS_DIR="$CONFIG_DIR/proxy-providers"

# 订阅转换 API
CONVERT_API="https://sub.xeton.dev/sub?target=clash&url="

# URL 编码
url_encode() {
    python3 -c "import urllib.parse; print(urllib.parse.quote('''$1''', safe=''))" 2>/dev/null || echo "$1"
}

# 显示帮助
show_help() {
    banner "Mihomo 订阅管理工具"
    echo "用法: mihomo-sub [命令] [选项]"
    echo ""
    echo "命令:"
    echo "  add <url>               添加/更换订阅链接"
    echo "  update                  更新当前订阅"
    echo "  list                    列出可用备份"
    echo "  restore [n]             恢复备份 (n为备份序号)"
    echo "  show                    显示当前订阅URL"
    echo "  test                    测试当前配置"
    echo "  menu                    交互式菜单"
    echo "  help                    显示帮助"
    echo ""
}

# 检查 root 权限
check_root() {
    if [ "$EUID" -ne 0 ]; then
        err "请使用 sudo 运行此脚本"
        exit 1
    fi
}

# 确认提示
confirm() {
    local msg="${1:-确认执行?}"
    read -p "$msg [Y/n]: " response
    [[ "$response" =~ ^[Yy]$ ]] || [ -z "$response" ]
}

# 询问 yes/no（带默认值）
ask_yesno() {
    local prompt="${1:-确认?}"
    local default="${2:-y}"
    
    read -p "$prompt [Y/n]: " response
    response="${response:-$default}"
    
    [[ "$response" =~ ^[Yy]$ ]]
}

# 备份配置
backup_config() {
    mkdir -p "$BACKUP_DIR"
    if [ -f "$CONFIG_FILE" ]; then
        local backup_name="config-$(date +%Y%m%d-%H%M%S).yaml"
        cp "$CONFIG_FILE" "$BACKUP_DIR/$backup_name"
        info "已备份: $backup_name"
    fi
}

# 下载并转换订阅
download_and_convert() {
    local url="$1"
    local temp_file="/tmp/mihomo_config_$(date +%s).yaml"
    
    info "下载订阅..."
    
    # 重试下载
    for i in 1 2 3; do
        if curl -sL --connect-timeout 10 --max-time 30 "$url" -o "$temp_file" 2>/dev/null; then
            break
        fi
        warn "第 $i 次下载失败，重试..."
        sleep 2
    done
    
    if [ ! -s "$temp_file" ]; then
        err "下载失败"
        rm -f "$temp_file"
        return 1
    fi
    
    log "下载成功"
    
    # 检测格式
    if grep -q "^proxies:" "$temp_file" 2>/dev/null; then
        info "检测到 Clash/Mihomo 格式，无需转换"
    else
        info "尝试转换格式..."
        
        # 尝试 base64 解码
        if base64 -d "$temp_file" > "${temp_file}.dec" 2>/dev/null; then
            mv "${temp_file}.dec" "$temp_file"
            log "Base64 解码成功"
        else
            rm -f "${temp_file}.dec"
        fi
        
        # 解码后再检测是否是 Clash 格式
        if ! grep -q "^proxies:" "$temp_file" 2>/dev/null; then
            info "使用在线服务转换为 Clash 格式..."
            
            # URL 编码
            local enc_url=$(url_encode "$url")
            local convert_url="${CONVERT_API}${enc_url}&insert=false&config="
            
            info "转换 URL: ${convert_url:0:60}..."
            
            if ! curl -sL --connect-timeout 15 --max-time 60 "$convert_url" -o "$temp_file" 2>/dev/null; then
                err "转换 API 请求失败"
                rm -f "$temp_file"
                return 1
            fi
            
            # 检查转换结果
            if ! grep -q "^proxies:" "$temp_file" 2>/dev/null; then
                err "转换后的文件格式不正确"
                err "响应内容: $(head -1 "$temp_file")"
                rm -f "$temp_file"
                return 1
            fi
            
            log "转换成功"
        fi
    fi
    
    # 检查并确保配置完整性
    info "检查配置完整性..."
    
    # 1. 确保有端口配置
    local port=7890
    if ! grep -qE "^(port:|mixed-port:)" "$temp_file"; then
        info "添加混合端口配置: $port"
        echo "" >> "$temp_file"
        echo "mixed-port: $port" >> "$temp_file"
    fi
    
    # 2. 确保有 socks 端口
    if ! grep -qE "^(socks-port:)" "$temp_file"; then
        echo "socks-port: 7891" >> "$temp_file"
    fi
    
    # 3. 其他基本配置
    grep -q "^allow-lan:" "$temp_file" || echo "allow-lan: true" >> "$temp_file"
    grep -q "^mode:" "$temp_file" || echo "mode: rule" >> "$temp_file"
    grep -q "^log-level:" "$temp_file" || echo "log-level: info" >> "$temp_file"
    grep -q "^external-controller:" "$temp_file" || echo "external-controller: 127.0.0.1:9090" >> "$temp_file"
    
    # 4. 确保有规则部分
    if ! grep -q "^rules:" "$temp_file"; then
        info "配置缺少规则部分，添加默认规则..."
        echo "" >> "$temp_file"
        echo "rules:" >> "$temp_file"
        echo "  - MATCH,PROXY" >> "$temp_file"
    fi
    
    # 5. 询问是否禁用 GEOIP
    if grep -q "GEOIP" "$temp_file" 2>/dev/null; then
        echo ""
        info "检测到 GEOIP 规则"
        if ask_yesno "是否禁用 GEOIP 规则? (可能导致配置验证警告)" "y"; then
            info "禁用 GEOIP 规则..."
            sed -i '/GEOIP/d' "$temp_file"
            log "已禁用 GEOIP 规则"
        fi
    fi
    
    # 验证配置
    if command -v mihomo &> /dev/null; then
        info "验证配置..."
        if ! mihomo -t -f "$temp_file" > /dev/null 2>&1; then
            warn "配置验证有警告，显示详细信息..."
            mihomo -t -f "$temp_file" 2>&1 | head -10
            
            if ! confirm "配置验证有警告，是否继续应用"; then
                rm -f "$temp_file"
                return 1
            fi
        else
            log "配置验证通过"
        fi
    fi
    
    # 备份并应用
    backup_config
    mv "$temp_file" "$CONFIG_FILE"
    echo "$url" > "$SUB_FILE"
    chmod 644 "$CONFIG_FILE"
    
    log "配置已应用到: $CONFIG_FILE"
    info "文件大小: $(ls -lh "$CONFIG_FILE" | awk '{print $5}')"
    info "代理节点数: $(grep -c "^  - name:" "$CONFIG_FILE" 2>/dev/null || echo "未知")"
    
    return 0
}

# 添加订阅
add_subscription() {
    local url="$1"
    
    if [ -z "$url" ]; then
        read -p "请输入订阅链接: " url
    fi
    
    if [ -z "$url" ]; then
        err "订阅链接不能为空"
        return 1
    fi
    
    if download_and_convert "$url"; then
        echo ""
        if ask_yesno "是否立即重启 Mihomo" "y"; then
            restart_mihomo
        fi
    fi
}

# 更新当前订阅
update_subscription() {
    if [ ! -f "$SUB_FILE" ]; then
        err "无订阅文件，请先添加订阅"
        return 1
    fi
    
    local url=$(cat "$SUB_FILE")
    info "更新订阅: $url"
    
    if download_and_convert "$url"; then
        log "订阅更新成功"
        
        # 检查服务状态
        if systemctl is-active --quiet mihomo 2>/dev/null; then
            echo ""
            if ask_yesno "是否重启 Mihomo 服务" "y"; then
                restart_mihomo
            fi
        fi
    fi
}

# 列出备份
list_backups() {
    if [ ! -d "$BACKUP_DIR" ] || [ -z "$(ls -A "$BACKUP_DIR" 2>/dev/null)" ]; then
        warn "没有可用的备份"
        return 1
    fi
    
    banner "可用备份"
    local i=1
    for f in $(ls -t "$BACKUP_DIR"/*.yaml 2>/dev/null); do
        [ -f "$f" ] || continue
        local size=$(ls -lh "$f" | awk '{print $5}')
        local mtime=$(stat -c %y "$f" 2>/dev/null | cut -d'.' -f1)
        echo "  $i. $(basename "$f") [$size] $mtime"
        ((i++))
    done
    return 0
}

# 恢复备份
restore_backup() {
    local choice="$1"
    
    if ! list_backups; then
        return 1
    fi
    
    if [ -z "$choice" ]; then
        read -p "选择要恢复的备份 (0取消): " choice
    fi
    
    [ "$choice" = "0" ] && return 0
    
    local selected=$(ls -t "$BACKUP_DIR"/*.yaml 2>/dev/null | sed -n "${choice}p")
    if [ -f "$selected" ]; then
        backup_config
        cp "$selected" "$CONFIG_FILE"
        log "已恢复: $(basename "$selected")"
        
        if ask_yesno "是否立即重启 Mihomo" "y"; then
            restart_mihomo
        fi
    else
        err "无效选择"
        return 1
    fi
}

# 显示当前订阅
show_subscription() {
    if [ -f "$SUB_FILE" ]; then
        log "当前订阅:"
        cat "$SUB_FILE"
    else
        warn "无订阅文件"
    fi
}

# 测试配置
test_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        err "配置文件不存在"
        return 1
    fi
    
    info "测试配置文件..."
    if mihomo -t -f "$CONFIG_FILE" 2>&1; then
        log "配置验证通过!"
    else
        err "配置验证失败"
        return 1
    fi
}

# 重启 Mihomo
restart_mihomo() {
    info "重启 Mihomo..."
    
    if systemctl is-active --quiet mihomo 2>/dev/null; then
        systemctl restart mihomo
    else
        systemctl start mihomo
    fi
    
    sleep 1
    if systemctl is-active --quiet mihomo 2>/dev/null; then
        log "Mihomo 已启动"
        systemctl status mihomo --no-pager
    else
        err "Mihomo 启动失败"
        systemctl status mihomo --no-pager
        return 1
    fi
}

# 交互式菜单
menu() {
    while true; do
        banner "Mihomo 订阅管理"
        echo "1. 添加/更换订阅链接"
        echo "2. 更新当前订阅"
        echo "3. 重启 Mihomo"
        echo "4. 恢复备份配置"
        echo "5. 查看当前订阅"
        echo "6. 测试配置"
        echo "0. 退出"
        echo ""
        read -p "选择: " c
        
        case $c in
            1)
                read -p "订阅链接: " url
                [ -n "$url" ] && add_subscription "$url"
                ;;
            2)
                update_subscription
                ;;
            3)
                restart_mihomo
                ;;
            4)
                restore_backup
                ;;
            5)
                show_subscription
                ;;
            6)
                test_config
                ;;
            0)
                exit 0
                ;;
            *)
                err "无效选择"
                ;;
        esac
        
        echo ""
        read -p "按回车继续..."
    done
}

# 主函数
main() {
    check_root
    
    # 创建必要目录
    mkdir -p "$CONFIG_DIR" "$BACKUP_DIR" "$PROVIDERS_DIR"
    
    case "$1" in
        add)
            add_subscription "$2"
            ;;
        update)
            update_subscription
            ;;
        list)
            list_backups
            ;;
        restore)
            restore_backup "$2"
            ;;
        show)
            show_subscription
            ;;
        test)
            test_config
            ;;
        menu)
            menu
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            menu
            ;;
    esac
}

main "$@"
