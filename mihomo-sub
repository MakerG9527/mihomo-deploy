#!/bin/bash
# Mihomo è®¢é˜…ç®¡ç†è„šæœ¬
# ç”¨äºä¸‹è½½ã€è½¬æ¢å’Œç®¡ç†è®¢é˜…é…ç½®

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# æ—¥å¿—å‡½æ•°
log() { echo -e "${GREEN}[âœ“]${NC} $*"; }
info() { echo -e "${BLUE}[â„¹]${NC} $*"; }
warn() { echo -e "${YELLOW}[!]${NC} $*"; }
err() { echo -e "${RED}[âœ—]${NC} $*" >&2; }
banner() {
    echo ""
    echo "========================================"
    echo "  $*"
    echo "========================================"
    echo ""
}

# é…ç½®è·¯å¾„
CONFIG_DIR="${CONFIG_DIR:-/etc/mihomo}"
CONFIG_FILE="$CONFIG_DIR/config.yaml"
SUB_FILE="$CONFIG_DIR/subscription.url"
BACKUP_DIR="$CONFIG_DIR/backups"
PROVIDERS_DIR="$CONFIG_DIR/proxy-providers"

# è®¢é˜…è½¬æ¢ API
CONVERT_API="https://sub.xeton.dev/sub?target=clash&url="

# URL ç¼–ç 
url_encode() {
    python3 -c "import urllib.parse; print(urllib.parse.quote('''$1''', safe=''))" 2>/dev/null || echo "$1"
}

# æ˜¾ç¤ºå¸®åŠ©
show_help() {
    banner "Mihomo è®¢é˜…ç®¡ç†å·¥å…·"
    echo "ç”¨æ³•: mihomo-sub [å‘½ä»¤] [é€‰é¡¹]"
    echo ""
    echo "å‘½ä»¤:"
    echo "  add <url>               æ·»åŠ /æ›´æ¢è®¢é˜…é“¾æ¥"
    echo "  update                  æ›´æ–°å½“å‰è®¢é˜…"
    echo "  list                    åˆ—å‡ºå¯ç”¨å¤‡ä»½"
    echo "  restore [n]             æ¢å¤å¤‡ä»½ (nä¸ºå¤‡ä»½åºå·)"
    echo "  show                    æ˜¾ç¤ºå½“å‰è®¢é˜…URL"
    echo "  test                    æµ‹è¯•å½“å‰é…ç½®"
    echo "  menu                    äº¤äº’å¼èœå•"
    echo "  help                    æ˜¾ç¤ºå¸®åŠ©"
    echo ""
}

# æ£€æŸ¥ root æƒé™
check_root() {
    if [ "$EUID" -ne 0 ]; then
        err "è¯·ä½¿ç”¨ sudo è¿è¡Œæ­¤è„šæœ¬"
        exit 1
    fi
}

# ç¡®è®¤æç¤º
confirm() {
    local msg="${1:-ç¡®è®¤æ‰§è¡Œ?}"
    read -p "$msg [Y/n]: " response
    [[ "$response" =~ ^[Yy]$ ]] || [ -z "$response" ]
}

# è¯¢é—® yes/noï¼ˆå¸¦é»˜è®¤å€¼ï¼‰
ask_yesno() {
    local prompt="${1:-ç¡®è®¤?}"
    local default="${2:-y}"
    
    read -p "$prompt [Y/n]: " response
    response="${response:-$default}"
    
    [[ "$response" =~ ^[Yy]$ ]]
}

# å¤‡ä»½é…ç½®
backup_config() {
    mkdir -p "$BACKUP_DIR"
    if [ -f "$CONFIG_FILE" ]; then
        local backup_name="config-$(date +%Y%m%d-%H%M%S).yaml"
        cp "$CONFIG_FILE" "$BACKUP_DIR/$backup_name"
        info "å·²å¤‡ä»½: $backup_name"
    fi
}

# ä¸‹è½½å¹¶è½¬æ¢è®¢é˜…
download_and_convert() {
    local url="$1"
    local temp_file="/tmp/mihomo_config_$(date +%s).yaml"
    
    info "ä¸‹è½½è®¢é˜…..."
    
    # é‡è¯•ä¸‹è½½
    for i in 1 2 3; do
        if curl -sL --connect-timeout 10 --max-time 30 "$url" -o "$temp_file" 2>/dev/null; then
            break
        fi
        warn "ç¬¬ $i æ¬¡ä¸‹è½½å¤±è´¥ï¼Œé‡è¯•..."
        sleep 2
    done
    
    if [ ! -s "$temp_file" ]; then
        err "ä¸‹è½½å¤±è´¥"
        rm -f "$temp_file"
        return 1
    fi
    
    log "ä¸‹è½½æˆåŠŸ"
    
    # æ£€æµ‹æ ¼å¼
    if grep -q "^proxies:" "$temp_file" 2>/dev/null; then
        info "æ£€æµ‹åˆ° Clash/Mihomo æ ¼å¼ï¼Œæ— éœ€è½¬æ¢"
    else
        info "å°è¯•è½¬æ¢æ ¼å¼..."
        
        # å°è¯• base64 è§£ç 
        if base64 -d "$temp_file" > "${temp_file}.dec" 2>/dev/null; then
            mv "${temp_file}.dec" "$temp_file"
            log "Base64 è§£ç æˆåŠŸ"
        else
            rm -f "${temp_file}.dec"
        fi
        
        # è§£ç åå†æ£€æµ‹æ˜¯å¦æ˜¯ Clash æ ¼å¼
        if ! grep -q "^proxies:" "$temp_file" 2>/dev/null; then
            info "ä½¿ç”¨åœ¨çº¿æœåŠ¡è½¬æ¢ä¸º Clash æ ¼å¼..."
            
            # URL ç¼–ç 
            local enc_url=$(url_encode "$url")
            local convert_url="${CONVERT_API}${enc_url}&insert=false&config="
            
            info "è½¬æ¢ URL: ${convert_url:0:60}..."
            
            if ! curl -sL --connect-timeout 15 --max-time 60 "$convert_url" -o "$temp_file" 2>/dev/null; then
                err "è½¬æ¢ API è¯·æ±‚å¤±è´¥"
                rm -f "$temp_file"
                return 1
            fi
            
            # æ£€æŸ¥è½¬æ¢ç»“æœ
            if ! grep -q "^proxies:" "$temp_file" 2>/dev/null; then
                err "è½¬æ¢åçš„æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®"
                err "å“åº”å†…å®¹: $(head -1 "$temp_file")"
                rm -f "$temp_file"
                return 1
            fi
            
            log "è½¬æ¢æˆåŠŸ"
        fi
    fi
    
    # æ£€æŸ¥å¹¶ç¡®ä¿é…ç½®å®Œæ•´æ€§
    info "æ£€æŸ¥é…ç½®å®Œæ•´æ€§..."
    
    # 1. ç¡®ä¿æœ‰ç«¯å£é…ç½®
    local port=7890
    if ! grep -qE "^(port:|mixed-port:)" "$temp_file"; then
        info "æ·»åŠ æ··åˆç«¯å£é…ç½®: $port"
        echo "" >> "$temp_file"
        echo "mixed-port: $port" >> "$temp_file"
    fi
    
    # 2. ç¡®ä¿æœ‰ socks ç«¯å£
    if ! grep -qE "^(socks-port:)" "$temp_file"; then
        echo "socks-port: 7891" >> "$temp_file"
    fi
    
    # 3. å…¶ä»–åŸºæœ¬é…ç½®
    grep -q "^allow-lan:" "$temp_file" || echo "allow-lan: true" >> "$temp_file"
    grep -q "^mode:" "$temp_file" || echo "mode: rule" >> "$temp_file"
    grep -q "^log-level:" "$temp_file" || echo "log-level: info" >> "$temp_file"
    grep -q "^external-controller:" "$temp_file" || echo "external-controller: 127.0.0.1:9090" >> "$temp_file"
    
    # 4. å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶æ£€æŸ¥å¹¶ä¿®å¤ MATCH è§„åˆ™
    # 4.1 å¦‚æœæ²¡æœ‰ rules éƒ¨åˆ†ï¼Œæ·»åŠ å®Œæ•´è§„åˆ™é›†
    if ! grep -q "^rules:" "$temp_file"; then
        info "é…ç½®ç¼ºå°‘è§„åˆ™éƒ¨åˆ†ï¼Œæ·»åŠ æ ‡å‡†è§„åˆ™é›†..."
        echo "" >> "$temp_file"
        echo "rules:" >> "$temp_file"
        echo "  - IP-CIDR,127.0.0.0/8,ğŸ¯ å…¨çƒç›´è¿,no-resolve" >> "$temp_file"
        echo "  - GEOIP,CN,ğŸ¯ å…¨çƒç›´è¿,no-resolve" >> "$temp_file"
        echo "  - MATCH,ğŸ”° èŠ‚ç‚¹é€‰æ‹©" >> "$temp_file"
    # 4.2 å¦‚æœæœ‰ rules ä½†æ²¡æœ‰ MATCH å…œåº•è§„åˆ™ï¼Œåˆ é™¤æ®‹ç¼ºçš„ rules å¹¶è¿½åŠ æ ‡å‡†è§„åˆ™é›†
    elif ! grep -qE "^[[:space:]]*- MATCH," "$temp_file"; then
        info "é…ç½®ç¼ºå°‘ MATCH å…œåº•è§„åˆ™ï¼Œä¿®å¤è§„åˆ™é›†..."
        sed -i '/^rules:/,$d' "$temp_file"
        echo "" >> "$temp_file"
        echo "rules:" >> "$temp_file"
        echo "  - IP-CIDR,127.0.0.0/8,ğŸ¯ å…¨çƒç›´è¿,no-resolve" >> "$temp_file"
        echo "  - GEOIP,CN,ğŸ¯ å…¨çƒç›´è¿,no-resolve" >> "$temp_file"
        echo "  - MATCH,ğŸ”° èŠ‚ç‚¹é€‰æ‹©" >> "$temp_file"
    fi
    
    # 5. å…³é”®ä¿®å¤ï¼šæ£€æŸ¥å¹¶ä¿®å¤æœªå®šä¹‰çš„ proxy-groups
    # æ£€æŸ¥æ˜¯å¦å¼•ç”¨äº† ğŸ¯ å…¨çƒç›´è¿ ä½†æœªå®šä¹‰
    if grep -q ",ğŸ¯ å…¨çƒç›´è¿" "$temp_file" && ! grep -q "name: ğŸ¯ å…¨çƒç›´è¿" "$temp_file"; then
        info "ä¿®å¤æœªå®šä¹‰çš„ proxy-group: ğŸ¯ å…¨çƒç›´è¿"
        # åœ¨ proxy-groups: åæ·»åŠ å®šä¹‰
        if grep -q "^proxy-groups:" "$temp_file"; then
            sed -i '/^proxy-groups:/a\  - name: ğŸ¯ å…¨çƒç›´è¿\n    type: select\n    proxies:\n      - DIRECT' "$temp_file"
        else
            # å¦‚æœæ²¡æœ‰ proxy-groups éƒ¨åˆ†ï¼Œæ·»åŠ å®Œæ•´çš„ proxy-groups
            echo "" >> "$temp_file"
            echo "proxy-groups:" >> "$temp_file"
            echo "  - name: ğŸ”° èŠ‚ç‚¹é€‰æ‹©" >> "$temp_file"
            echo "    type: select" >> "$temp_file"
            echo "    proxies:" >> "$temp_file"
            echo "      - DIRECT" >> "$temp_file"
            echo "  - name: ğŸ¯ å…¨çƒç›´è¿" >> "$temp_file"
            echo "    type: select" >> "$temp_file"
            echo "    proxies:" >> "$temp_file"
            echo "      - DIRECT" >> "$temp_file"
        fi
    fi
    
    # æ£€æŸ¥æ˜¯å¦å¼•ç”¨äº† â™»ï¸ è‡ªåŠ¨é€‰æ‹© ä½†æœªå®šä¹‰
    if grep -q "â™»ï¸ è‡ªåŠ¨é€‰æ‹©" "$temp_file" && ! grep -q "name: â™»ï¸ è‡ªåŠ¨é€‰æ‹©" "$temp_file"; then
        info "ä¿®å¤æœªå®šä¹‰çš„ proxy-group: â™»ï¸ è‡ªåŠ¨é€‰æ‹©"
        if grep -q "^proxy-groups:" "$temp_file"; then
            sed -i '/^proxy-groups:/a\  - name: â™»ï¸ è‡ªåŠ¨é€‰æ‹©\n    type: url-test\n    url: http://www.gstatic.com/generate_204\n    interval: 300\n    tolerance: 50\n    proxies:' "$temp_file"
        fi
    fi
    
    # 6. è¯¢é—®æ˜¯å¦ç¦ç”¨ GEOIP
    if grep -q "GEOIP" "$temp_file" 2>/dev/null; then
        echo ""
        info "æ£€æµ‹åˆ° GEOIP è§„åˆ™"
        if ask_yesno "æ˜¯å¦ç¦ç”¨ GEOIP è§„åˆ™? (å¯èƒ½å¯¼è‡´é…ç½®éªŒè¯è­¦å‘Š)" "y"; then
            info "ç¦ç”¨ GEOIP è§„åˆ™..."
            sed -i '/GEOIP/d' "$temp_file"
            log "å·²ç¦ç”¨ GEOIP è§„åˆ™"
        fi
    fi
    
    # éªŒè¯é…ç½®
    if command -v mihomo &> /dev/null; then
        info "éªŒè¯é…ç½®..."
        if ! mihomo -t -f "$temp_file" > /dev/null 2>&1; then
            warn "é…ç½®éªŒè¯æœ‰è­¦å‘Šï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯..."
            mihomo -t -f "$temp_file" 2>&1 | head -10
            
            if ! confirm "é…ç½®éªŒè¯æœ‰è­¦å‘Šï¼Œæ˜¯å¦ç»§ç»­åº”ç”¨"; then
                rm -f "$temp_file"
                return 1
            fi
        else
            log "é…ç½®éªŒè¯é€šè¿‡"
        fi
    fi
    
    # å¤‡ä»½å¹¶åº”ç”¨
    backup_config
    mv "$temp_file" "$CONFIG_FILE"
    echo "$url" > "$SUB_FILE"
    chmod 644 "$CONFIG_FILE"
    
    log "é…ç½®å·²åº”ç”¨åˆ°: $CONFIG_FILE"
    info "æ–‡ä»¶å¤§å°: $(ls -lh "$CONFIG_FILE" | awk '{print $5}')"
    info "ä»£ç†èŠ‚ç‚¹æ•°: $(grep -c "^  - name:" "$CONFIG_FILE" 2>/dev/null || echo "æœªçŸ¥")"
    
    return 0
}

# æ·»åŠ è®¢é˜…
add_subscription() {
    local url="$1"
    
    if [ -z "$url" ]; then
        read -p "è¯·è¾“å…¥è®¢é˜…é“¾æ¥: " url
    fi
    
    if [ -z "$url" ]; then
        err "è®¢é˜…é“¾æ¥ä¸èƒ½ä¸ºç©º"
        return 1
    fi
    
    if download_and_convert "$url"; then
        echo ""
        if ask_yesno "æ˜¯å¦ç«‹å³é‡å¯ Mihomo" "y"; then
            restart_mihomo
        fi
    fi
}

# æ›´æ–°å½“å‰è®¢é˜…
update_subscription() {
    if [ ! -f "$SUB_FILE" ]; then
        err "æ— è®¢é˜…æ–‡ä»¶ï¼Œè¯·å…ˆæ·»åŠ è®¢é˜…"
        return 1
    fi
    
    local url=$(cat "$SUB_FILE")
    info "æ›´æ–°è®¢é˜…: $url"
    
    if download_and_convert "$url"; then
        log "è®¢é˜…æ›´æ–°æˆåŠŸ"
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        if systemctl is-active --quiet mihomo 2>/dev/null; then
            echo ""
            if ask_yesno "æ˜¯å¦é‡å¯ Mihomo æœåŠ¡" "y"; then
                restart_mihomo
            fi
        fi
    fi
}

# åˆ—å‡ºå¤‡ä»½
list_backups() {
    if [ ! -d "$BACKUP_DIR" ] || [ -z "$(ls -A "$BACKUP_DIR" 2>/dev/null)" ]; then
        warn "æ²¡æœ‰å¯ç”¨çš„å¤‡ä»½"
        return 1
    fi
    
    banner "å¯ç”¨å¤‡ä»½"
    local i=1
    for f in $(ls -t "$BACKUP_DIR"/*.yaml 2>/dev/null); do
        [ -f "$f" ] || continue
        local size=$(ls -lh "$f" | awk '{print $5}')
        local mtime=$(stat -c %y "$f" 2>/dev/null | cut -d'.' -f1)
        echo "  $i. $(basename "$f") [$size] $mtime"
        ((i++))
    done
    return 0
}

# æ¢å¤å¤‡ä»½
restore_backup() {
    local choice="$1"
    
    if ! list_backups; then
        return 1
    fi
    
    if [ -z "$choice" ]; then
        read -p "é€‰æ‹©è¦æ¢å¤çš„å¤‡ä»½ (0å–æ¶ˆ): " choice
    fi
    
    [ "$choice" = "0" ] && return 0
    
    local selected=$(ls -t "$BACKUP_DIR"/*.yaml 2>/dev/null | sed -n "${choice}p")
    if [ -f "$selected" ]; then
        backup_config
        cp "$selected" "$CONFIG_FILE"
        log "å·²æ¢å¤: $(basename "$selected")"
        
        if ask_yesno "æ˜¯å¦ç«‹å³é‡å¯ Mihomo" "y"; then
            restart_mihomo
        fi
    else
        err "æ— æ•ˆé€‰æ‹©"
        return 1
    fi
}

# æ˜¾ç¤ºå½“å‰è®¢é˜…
show_subscription() {
    if [ -f "$SUB_FILE" ]; then
        log "å½“å‰è®¢é˜…:"
        cat "$SUB_FILE"
    else
        warn "æ— è®¢é˜…æ–‡ä»¶"
    fi
}

# æµ‹è¯•é…ç½®
test_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        err "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
        return 1
    fi
    
    info "æµ‹è¯•é…ç½®æ–‡ä»¶..."
    if mihomo -t -f "$CONFIG_FILE" 2>&1; then
        log "é…ç½®éªŒè¯é€šè¿‡!"
    else
        err "é…ç½®éªŒè¯å¤±è´¥"
        return 1
    fi
}

# é‡å¯ Mihomo
restart_mihomo() {
    info "é‡å¯ Mihomo..."
    
    if systemctl is-active --quiet mihomo 2>/dev/null; then
        systemctl restart mihomo
    else
        systemctl start mihomo
    fi
    
    sleep 1
    if systemctl is-active --quiet mihomo 2>/dev/null; then
        log "Mihomo å·²å¯åŠ¨"
        systemctl status mihomo --no-pager
    else
        err "Mihomo å¯åŠ¨å¤±è´¥"
        systemctl status mihomo --no-pager
        return 1
    fi
}

# äº¤äº’å¼èœå•
menu() {
    while true; do
        banner "Mihomo è®¢é˜…ç®¡ç†"
        echo "1. æ·»åŠ /æ›´æ¢è®¢é˜…é“¾æ¥"
        echo "2. æ›´æ–°å½“å‰è®¢é˜…"
        echo "3. é‡å¯ Mihomo"
        echo "4. æ¢å¤å¤‡ä»½é…ç½®"
        echo "5. æŸ¥çœ‹å½“å‰è®¢é˜…"
        echo "6. æµ‹è¯•é…ç½®"
        echo "0. é€€å‡º"
        echo ""
        read -p "é€‰æ‹©: " c
        
        case $c in
            1)
                read -p "è®¢é˜…é“¾æ¥: " url
                [ -n "$url" ] && add_subscription "$url"
                ;;
            2)
                update_subscription
                ;;
            3)
                restart_mihomo
                ;;
            4)
                restore_backup
                ;;
            5)
                show_subscription
                ;;
            6)
                test_config
                ;;
            0)
                exit 0
                ;;
            *)
                err "æ— æ•ˆé€‰æ‹©"
                ;;
        esac
        
        echo ""
        read -p "æŒ‰å›è½¦ç»§ç»­..."
    done
}

# ä¸»å‡½æ•°
main() {
    check_root
    
    # åˆ›å»ºå¿…è¦ç›®å½•
    mkdir -p "$CONFIG_DIR" "$BACKUP_DIR" "$PROVIDERS_DIR"
    
    case "$1" in
        add)
            add_subscription "$2"
            ;;
        update)
            update_subscription
            ;;
        list)
            list_backups
            ;;
        restore)
            restore_backup "$2"
            ;;
        show)
            show_subscription
            ;;
        test)
            test_config
            ;;
        menu)
            menu
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            menu
            ;;
    esac
}

main "$@"
