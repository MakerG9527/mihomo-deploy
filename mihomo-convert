#!/bin/bash
# Mihomo URL 转换工具
# 用于转换各种代理 URL 格式

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# 显示帮助
show_help() {
    echo -e "${GREEN}Mihomo URL 转换工具${NC}"
    echo ""
    echo "用法: mihomo-convert [选项] <URL|文件>"
    echo ""
    echo "选项:"
    echo "  -t, --type <type>     输出格式类型 (yaml, json, base64, uri)"
    echo "  -o, --output <file>   输出文件路径"
    echo "  -d, --decode          解码模式 (将配置转换为 URL)"
    echo "  -c, --clash           转换为 Clash/Mihomo 格式"
    echo "  -s, --sing-box        转换为 sing-box 格式"
    echo "  -h, --help            显示帮助"
    echo ""
    echo "支持的输入格式:"
    echo "  - 订阅链接 (HTTP/HTTPS)"
    echo "  - Base64 编码的节点列表"
    echo "  - SS/VMess/VLESS/Trojan 分享链接"
    echo "  - Clash/Mihomo YAML 配置"
    echo ""
    echo "示例:"
    echo "  mihomo-convert 'ss://...'"
    echo "  mihomo-convert -t yaml -o nodes.yaml 'vmess://...'"
    echo "  mihomo-convert -c https://example.com/subscription"
    echo "  cat nodes.txt | mihomo-convert -t yaml"
}

# URL 解码
url_decode() {
    local encoded="$1"
    printf '%b' "${encoded//%/\\x}"
}

# Base64 解码
base64_decode() {
    local data="$1"
    # 尝试标准 base64，如果失败尝试 URL-safe base64
    echo "$data" | tr '_-' '/+' | base64 -d 2>/dev/null || \
    echo "$data" | base64 -d 2>/dev/null || \
    echo "$data" | tr '_-' '/+' | base64 -d -i 2>/dev/null || \
    echo "$data"
}

# 解析 SS URL
parse_ss() {
    local url="$1"
    # ss://method:password@server:port#name
    # ss://base64(method:password)@server:port#name
    
    local encoded_part=$(echo "$url" | sed 's|ss://||' | cut -d'@' -f1)
    local server_part=$(echo "$url" | sed 's|ss://||' | cut -d'@' -f2 | cut -d'#' -f1)
    local name=$(echo "$url" | grep -o '#.*$' | sed 's/^#//' | url_decode)
    
    # 尝试解码
    local decoded=$(base64_decode "$encoded_part")
    
    if [[ "$decoded" == *":"* ]]; then
        local method=$(echo "$decoded" | cut -d':' -f1)
        local password=$(echo "$decoded" | cut -d':' -f2-)
    else
        # 可能是 base64(method:password)@server:port 格式
        local method=""
        local password=""
    fi
    
    local server=$(echo "$server_part" | cut -d':' -f1)
    local port=$(echo "$server_part" | cut -d':' -f2)
    
    [ -z "$name" ] && name="SS-$server"
    
    echo "  - name: \"$name\""
    echo "    type: ss"
    echo "    server: $server"
    echo "    port: $port"
    echo "    cipher: ${method:-aes-256-gcm}"
    echo "    password: \"$password\""
}

# 解析 VMess URL
parse_vmess() {
    local url="$1"
    # vmess://base64(json)
    
    local encoded=$(echo "$url" | sed 's|vmess://||')
    local json=$(base64_decode "$encoded")
    
    # 提取字段
    local ps=$(echo "$json" | grep -o '"ps"[^,]*' | cut -d'"' -f4)
    local add=$(echo "$json" | grep -o '"add"[^,]*' | cut -d'"' -f4)
    local port=$(echo "$json" | grep -o '"port"[^,]*' | grep -o '[0-9]*')
    local id=$(echo "$json" | grep -o '"id"[^,]*' | cut -d'"' -f4)
    local aid=$(echo "$json" | grep -o '"aid"[^,]*' | grep -o '[0-9]*' | head -1)
    local net=$(echo "$json" | grep -o '"net"[^,]*' | cut -d'"' -f4)
    local tls=$(echo "$json" | grep -o '"tls"[^,]*' | cut -d'"' -f4)
    
    [ -z "$ps" ] && ps="VMess-$add"
    [ -z "$aid" ] && aid="0"
    
    echo "  - name: \"$ps\""
    echo "    type: vmess"
    echo "    server: $add"
    echo "    port: ${port:-443}"
    echo "    uuid: $id"
    echo "    alterId: ${aid:-0}"
    echo "    cipher: auto"
    [ "$tls" = "tls" ] && echo "    tls: true"
    [ "$net" = "ws" ] && echo "    network: ws"
}

# 解析 Trojan URL
parse_trojan() {
    local url="$1"
    # trojan://password@server:port?params#name
    
    local password=$(echo "$url" | sed 's|trojan://||' | cut -d'@' -f1 | url_decode)
    local server_part=$(echo "$url" | sed 's|trojan://||' | cut -d'@' -f2 | cut -d'?' -f1 | cut -d'#' -f1)
    local params=$(echo "$url" | grep -o '?[^#]*' | sed 's/^?//')
    local name=$(echo "$url" | grep -o '#.*$' | sed 's/^#//' | url_decode)
    
    local server=$(echo "$server_part" | cut -d':' -f1)
    local port=$(echo "$server_part" | cut -d':' -f2)
    
    [ -z "$name" ] && name="Trojan-$server"
    
    echo "  - name: \"$name\""
    echo "    type: trojan"
    echo "    server: $server"
    echo "    port: ${port:-443}"
    echo "    password: \"$password\""
    
    if [[ "$params" == *"sni="* ]]; then
        local sni=$(echo "$params" | grep -o 'sni=[^&]*' | cut -d'=' -f2)
        echo "    sni: \"$sni\""
    fi
}

# 解析 VLESS URL
parse_vless() {
    local url="$1"
    # vless://id@server:port?params#name
    
    local id=$(echo "$url" | sed 's|vless://||' | cut -d'@' -f1)
    local server_part=$(echo "$url" | sed 's|vless://||' | cut -d'@' -f2 | cut -d'?' -f1 | cut -d'#' -f1)
    local params=$(echo "$url" | grep -o '?[^#]*' | sed 's/^?//')
    local name=$(echo "$url" | grep -o '#.*$' | sed 's/^#//' | url_decode)
    
    local server=$(echo "$server_part" | cut -d':' -f1)
    local port=$(echo "$server_part" | cut -d':' -f2)
    
    [ -z "$name" ] && name="VLESS-$server"
    
    echo "  - name: \"$name\""
    echo "    type: vless"
    echo "    server: $server"
    echo "    port: ${port:-443}"
    echo "    uuid: $id"
    
    if [[ "$params" == *"encryption="* ]]; then
        local encryption=$(echo "$params" | grep -o 'encryption=[^&]*' | cut -d'=' -f2)
        [ -n "$encryption" ] && echo "    cipher: \"$encryption\""
    fi
    
    if [[ "$params" == *"security=tls"* ]] || [[ "$params" == *"security=xts"* ]]; then
        echo "    tls: true"
    fi
    
    if [[ "$params" == *"type=ws"* ]]; then
        echo "    network: ws"
        if [[ "$params" == *"path="* ]]; then
            local path=$(echo "$params" | grep -o 'path=[^&]*' | cut -d'=' -f2 | url_decode)
            echo "    ws-opts:"
            echo "      path: \"$path\""
        fi
    fi
}

# 解析单个 URL
parse_url() {
    local url="$1"
    
    case "$url" in
        ss://*)
            parse_ss "$url"
            ;;
        vmess://*)
            parse_vmess "$url"
            ;;
        trojan://*)
            parse_trojan "$url"
            ;;
        vless://*)
            parse_vless "$url"
            ;;
        *)
            echo -e "${YELLOW}未知的 URL 格式: ${url:0:30}...${NC}" >&2
            ;;
    esac
}

# 处理订阅内容
process_subscription() {
    local content="$1"
    local output_type="${2:-yaml}"
    
    # 检查是否是 base64 编码
    local decoded=$(base64_decode "$content")
    
    # 如果解码后包含 ://，说明是 URL 列表
    if [[ "$decoded" == *"://"* ]]; then
        content="$decoded"
    fi
    
    # 输出 YAML 格式
    if [ "$output_type" = "yaml" ]; then
        echo "proxies:"
        
        # 逐行解析
        echo "$content" | while IFS= read -r line; do
            [ -z "$line" ] && continue
            parse_url "$line"
        done
    else
        echo "$content"
    fi
}

# 从 URL 获取订阅
fetch_subscription() {
    local url="$1"
    
    if command -v curl &> /dev/null; then
        curl -sL --connect-timeout 30 --max-time 60 "$url" 2>/dev/null
    elif command -v wget &> /dev/null; then
        wget -qO- --timeout=30 "$url" 2>/dev/null
    else
        echo -e "${RED}错误: 需要 curl 或 wget${NC}" >&2
        exit 1
    fi
}

# 主函数
main() {
    local output_type="yaml"
    local output_file=""
    local input=""
    
    # 解析参数
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -t|--type)
                output_type="$2"
                shift 2
                ;;
            -o|--output)
                output_file="$2"
                shift 2
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            -*)
                echo -e "${RED}未知选项: $1${NC}" >&2
                show_help
                exit 1
                ;;
            *)
                input="$1"
                shift
                ;;
        esac
    done
    
    # 如果没有输入，从 stdin 读取
    if [ -z "$input" ]; then
        if [ -t 0 ]; then
            show_help
            exit 1
        fi
        input=$(cat)
    fi
    
    local result=""
    
    # 判断输入类型
    if [[ "$input" == http* ]]; then
        # 订阅 URL
        echo -e "${BLUE}正在获取订阅: ${input:0:50}...${NC}" >&2
        local content=$(fetch_subscription "$input")
        if [ -z "$content" ]; then
            echo -e "${RED}获取订阅失败${NC}" >&2
            exit 1
        fi
        result=$(process_subscription "$content" "$output_type")
    elif [[ "$input" == *"://"* ]]; then
        # 单个 URL 或多个 URL
        result=$(process_subscription "$input" "$output_type")
    elif [ -f "$input" ]; then
        # 文件
        local content=$(cat "$input")
        result=$(process_subscription "$content" "$output_type")
    else
        # 可能是 base64 编码的内容
        result=$(process_subscription "$input" "$output_type")
    fi
    
    # 输出结果
    if [ -n "$output_file" ]; then
        echo "$result" > "$output_file"
        echo -e "${GREEN}结果已保存到: $output_file${NC}"
    else
        echo "$result"
    fi
}

main "$@"
