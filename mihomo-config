#!/bin/bash
# Mihomo é…ç½®ç®¡ç†è„šæœ¬
# ç”¨äºç®¡ç† mihomo é…ç½®æ–‡ä»¶å’Œè®¢é˜…

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

CONFIG_DIR="${CONFIG_DIR:-/etc/mihomo}"
CONFIG_FILE="$CONFIG_DIR/config.yaml"
SUBSCRIPTIONS_FILE="$CONFIG_DIR/subscriptions.txt"

# æ˜¾ç¤ºå¸®åŠ©
show_help() {
    echo -e "${GREEN}Mihomo é…ç½®ç®¡ç†å·¥å…·${NC}"
    echo ""
    echo "ç”¨æ³•: mihomo-config [å‘½ä»¤] [é€‰é¡¹]"
    echo ""
    echo "å‘½ä»¤:"
    echo "  add-sub <url> [name]     æ·»åŠ è®¢é˜…é“¾æ¥"
    echo "  remove-sub <name>        åˆ é™¤è®¢é˜…é“¾æ¥"
    echo "  list-subs                åˆ—å‡ºæ‰€æœ‰è®¢é˜…"
    echo "  update-subs              æ›´æ–°æ‰€æœ‰è®¢é˜…"
    echo "  set-port <port>          è®¾ç½® HTTP ä»£ç†ç«¯å£"
    echo "  set-mixed-port <port>    è®¾ç½® Mixed ä»£ç†ç«¯å£"
    echo "  set-tproxy-port <port>   è®¾ç½® TPROXY ç«¯å£"
    echo "  enable-tproxy            å¯ç”¨é€æ˜ä»£ç†"
    echo "  disable-tproxy           ç¦ç”¨é€æ˜ä»£ç†"
    echo "  test                     æµ‹è¯•é…ç½®æ–‡ä»¶"
    echo "  edit                     ç¼–è¾‘é…ç½®æ–‡ä»¶"
    echo "  status                   æŸ¥çœ‹é…ç½®çŠ¶æ€"
    echo "  backup                   å¤‡ä»½é…ç½®æ–‡ä»¶"
    echo "  restore <file>           ä»å¤‡ä»½æ¢å¤"
    echo "  help                     æ˜¾ç¤ºå¸®åŠ©"
    echo ""
}

# æ£€æŸ¥ root æƒé™
check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo -e "${RED}è¯·ä½¿ç”¨ sudo è¿è¡Œæ­¤è„šæœ¬${NC}"
        exit 1
    fi
}

# æ·»åŠ è®¢é˜…
add_subscription() {
    local url="$1"
    local name="${2:-provider$(date +%s)}"
    
    if [ -z "$url" ]; then
        echo -e "${RED}é”™è¯¯: è¯·æä¾›è®¢é˜… URL${NC}"
        exit 1
    fi
    
    # ä¿å­˜è®¢é˜…åˆ°æ–‡ä»¶
    echo "$name|$url" >> "$SUBSCRIPTIONS_FILE"
    
    # æ›´æ–°é…ç½®æ–‡ä»¶
    update_config_with_sub "$name" "$url"
    
    echo -e "${GREEN}è®¢é˜…å·²æ·»åŠ : $name${NC}"
}

# æ›´æ–°é…ç½®æ–‡ä»¶ä¸­çš„è®¢é˜…
update_config_with_sub() {
    local name="$1"
    local url="$2"
    
    # å¤‡ä»½åŸé…ç½®
    if [ -f "$CONFIG_FILE" ]; then
        cp "$CONFIG_FILE" "$CONFIG_FILE.backup.$(date +%Y%m%d%H%M%S)"
    fi
    
    # å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®
    if [ ! -f "$CONFIG_FILE" ]; then
        create_default_config
    fi
    
    # ä½¿ç”¨ sed æˆ–ä¸´æ—¶æ–‡ä»¶æ–¹å¼æ·»åŠ è®¢é˜…é…ç½®
    # è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…ä½¿ç”¨æ—¶å»ºè®®ç”¨ yq ç­‰ YAML å·¥å…·
    echo -e "${YELLOW}è¯·æ‰‹åŠ¨ç¼–è¾‘é…ç½®æ–‡ä»¶æ·»åŠ è®¢é˜…:${NC}"
    echo -e "åœ¨ proxy-providers: ä¸‹æ·»åŠ :"
    echo ""
    echo "  $name:"
    echo "    type: http"
    echo "    url: \"$url\""
    echo "    interval: 3600"
    echo "    path: ./proxy-providers/$name.yaml"
    echo "    health-check:"
    echo "      enable: true"
    echo "      url: https://www.gstatic.com/generate_204"
    echo "      interval: 300"
    echo ""
}

# åˆ›å»ºé»˜è®¤é…ç½®
create_default_config() {
    mkdir -p "$CONFIG_DIR"
    cat > "$CONFIG_FILE" << 'EOF'
port: 7890
socks-port: 7891
mixed-port: 7892
redir-port: 7895
tproxy-port: 7896

allow-lan: true
bind-address: '*'
mode: rule
log-level: info
external-controller: 127.0.0.1:9090

proxy-providers: {}

proxies:
  - name: "DIRECT"
    type: direct
    udp: true

proxy-groups:
  - name: "ğŸš€ èŠ‚ç‚¹é€‰æ‹©"
    type: select
    proxies:
      - DIRECT

  - name: "ğŸ¯ å…¨çƒç›´è¿"
    type: select
    proxies:
      - DIRECT

  - name: "ğŸ›‘ å…¨çƒæ‹¦æˆª"
    type: select
    proxies:
      - REJECT
      - DIRECT

  - name: "ğŸŸ æ¼ç½‘ä¹‹é±¼"
    type: select
    proxies:
      - "ğŸš€ èŠ‚ç‚¹é€‰æ‹©"
      - DIRECT

rules:
  - DOMAIN-SUFFIX,local,DIRECT
  - IP-CIDR,127.0.0.0/8,DIRECT
  - IP-CIDR,172.16.0.0/12,DIRECT
  - IP-CIDR,192.168.0.0/16,DIRECT
  - IP-CIDR,10.0.0.0/8,DIRECT
  - IP-CIDR,169.254.0.0/16,DIRECT
  - IP-CIDR,224.0.0.0/4,DIRECT
  - IP-CIDR,fe80::/10,DIRECT
  - GEOIP,CN,DIRECT
  - MATCH,ğŸŸ æ¼ç½‘ä¹‹é±¼
EOF
}

# åˆ—å‡ºè®¢é˜…
list_subscriptions() {
    if [ ! -f "$SUBSCRIPTIONS_FILE" ] || [ ! -s "$SUBSCRIPTIONS_FILE" ]; then
        echo -e "${YELLOW}æ²¡æœ‰ä¿å­˜çš„è®¢é˜…${NC}"
        return
    fi
    
    echo -e "${GREEN}å·²ä¿å­˜çš„è®¢é˜…:${NC}"
    echo ""
    local i=1
    while IFS='|' read -r name url; do
        echo -e "${BLUE}$i. $name${NC}"
        echo "   URL: ${url:0:50}..."
        ((i++))
    done < "$SUBSCRIPTIONS_FILE"
}

# åˆ é™¤è®¢é˜…
remove_subscription() {
    local name="$1"
    
    if [ -z "$name" ]; then
        echo -e "${RED}é”™è¯¯: è¯·æä¾›è®¢é˜…åç§°${NC}"
        exit 1
    fi
    
    if [ ! -f "$SUBSCRIPTIONS_FILE" ]; then
        echo -e "${RED}æ²¡æœ‰æ‰¾åˆ°è®¢é˜…æ–‡ä»¶${NC}"
        exit 1
    fi
    
    grep -v "^$name|" "$SUBSCRIPTIONS_FILE" > "$SUBSCRIPTIONS_FILE.tmp" || true
    mv "$SUBSCRIPTIONS_FILE.tmp" "$SUBSCRIPTIONS_FILE"
    
    echo -e "${GREEN}è®¢é˜…å·²åˆ é™¤: $name${NC}"
}

# è®¾ç½®ç«¯å£
set_port() {
    local port="$1"
    
    if [ -z "$port" ]; then
        echo -e "${RED}é”™è¯¯: è¯·æä¾›ç«¯å£å·${NC}"
        exit 1
    fi
    
    backup_config
    
    sed -i "s/^port:.*/port: $port/" "$CONFIG_FILE"
    echo -e "${GREEN}HTTP ç«¯å£å·²è®¾ç½®ä¸º: $port${NC}"
    
    restart_if_running
}

# è®¾ç½® mixed ç«¯å£
set_mixed_port() {
    local port="$1"
    
    if [ -z "$port" ]; then
        echo -e "${RED}é”™è¯¯: è¯·æä¾›ç«¯å£å·${NC}"
        exit 1
    fi
    
    backup_config
    
    sed -i "s/^mixed-port:.*/mixed-port: $port/" "$CONFIG_FILE"
    echo -e "${GREEN}Mixed ç«¯å£å·²è®¾ç½®ä¸º: $port${NC}"
    
    restart_if_running
}

# è®¾ç½® tproxy ç«¯å£
set_tproxy_port() {
    local port="$1"
    
    if [ -z "$port" ]; then
        echo -e "${RED}é”™è¯¯: è¯·æä¾›ç«¯å£å·${NC}"
        exit 1
    fi
    
    backup_config
    
    sed -i "s/^tproxy-port:.*/tproxy-port: $port/" "$CONFIG_FILE"
    echo -e "${GREEN}TPROXY ç«¯å£å·²è®¾ç½®ä¸º: $port${NC}"
    
    restart_if_running
}

# å¯ç”¨é€æ˜ä»£ç†
enable_tproxy() {
    if [ -f "$CONFIG_DIR/enable-tproxy.sh" ]; then
        "$CONFIG_DIR/enable-tproxy.sh"
        echo -e "${GREEN}é€æ˜ä»£ç†å·²å¯ç”¨${NC}"
    else
        echo -e "${RED}é€æ˜ä»£ç†è„šæœ¬ä¸å­˜åœ¨${NC}"
        exit 1
    fi
}

# ç¦ç”¨é€æ˜ä»£ç†
disable_tproxy() {
    if [ -f "$CONFIG_DIR/disable-tproxy.sh" ]; then
        "$CONFIG_DIR/disable-tproxy.sh"
        echo -e "${GREEN}é€æ˜ä»£ç†å·²ç¦ç”¨${NC}"
    else
        echo -e "${RED}é€æ˜ä»£ç†è„šæœ¬ä¸å­˜åœ¨${NC}"
        exit 1
    fi
}

# æµ‹è¯•é…ç½®
test_config() {
    echo -e "${BLUE}æµ‹è¯•é…ç½®æ–‡ä»¶...${NC}"
    
    if mihomo -t -f "$CONFIG_FILE" 2>&1; then
        echo -e "${GREEN}é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡!${NC}"
    else
        echo -e "${RED}é…ç½®æ–‡ä»¶æœ‰é”™è¯¯ï¼Œè¯·æ£€æŸ¥${NC}"
        exit 1
    fi
}

# ç¼–è¾‘é…ç½®
edit_config() {
    local editor="${EDITOR:-nano}"
    
    if command -v "$editor" &> /dev/null; then
        $editor "$CONFIG_FILE"
    else
        nano "$CONFIG_FILE"
    fi
}

# æŸ¥çœ‹çŠ¶æ€
show_status() {
    echo -e "${GREEN}=== Mihomo é…ç½®çŠ¶æ€ ===${NC}"
    echo ""
    
    echo -e "${BLUE}é…ç½®æ–‡ä»¶:${NC} $CONFIG_FILE"
    if [ -f "$CONFIG_FILE" ]; then
        echo -e "${GREEN}âœ“ é…ç½®æ–‡ä»¶å­˜åœ¨${NC}"
        
        # æå–ç«¯å£ä¿¡æ¯
        local port=$(grep "^port:" "$CONFIG_FILE" | awk '{print $2}')
        local mixed_port=$(grep "^mixed-port:" "$CONFIG_FILE" | awk '{print $2}')
        local tproxy_port=$(grep "^tproxy-port:" "$CONFIG_FILE" | awk '{print $2}')
        
        echo -e "${BLUE}HTTP ç«¯å£:${NC} ${port:-æœªè®¾ç½®}"
        echo -e "${BLUE}Mixed ç«¯å£:${NC} ${mixed_port:-æœªè®¾ç½®}"
        echo -e "${BLUE}TPROXY ç«¯å£:${NC} ${tproxy_port:-æœªè®¾ç½®}"
    else
        echo -e "${RED}âœ— é…ç½®æ–‡ä»¶ä¸å­˜åœ¨${NC}"
    fi
    
    echo ""
    echo -e "${BLUE}æœåŠ¡çŠ¶æ€:${NC}"
    systemctl is-active mihomo 2>/dev/null && echo -e "${GREEN}è¿è¡Œä¸­${NC}" || echo -e "${RED}æœªè¿è¡Œ${NC}"
    
    echo ""
    list_subscriptions
}

# å¤‡ä»½é…ç½®
backup_config() {
    local backup_file="$CONFIG_DIR/config.yaml.backup.$(date +%Y%m%d%H%M%S)"
    if [ -f "$CONFIG_FILE" ]; then
        cp "$CONFIG_FILE" "$backup_file"
        echo -e "${GREEN}é…ç½®å·²å¤‡ä»½åˆ°: $backup_file${NC}"
    fi
}

# æ¢å¤é…ç½®
restore_config() {
    local backup_file="$1"
    
    if [ -z "$backup_file" ]; then
        echo -e "${RED}é”™è¯¯: è¯·æä¾›å¤‡ä»½æ–‡ä»¶è·¯å¾„${NC}"
        exit 1
    fi
    
    if [ ! -f "$backup_file" ]; then
        echo -e "${RED}é”™è¯¯: å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨${NC}"
        exit 1
    fi
    
    cp "$backup_file" "$CONFIG_FILE"
    echo -e "${GREEN}é…ç½®å·²ä» $backup_file æ¢å¤${NC}"
    
    restart_if_running
}

# å¦‚æœæœåŠ¡åœ¨è¿è¡Œåˆ™é‡å¯
restart_if_running() {
    if systemctl is-active --quiet mihomo 2>/dev/null; then
        echo -e "${BLUE}é‡å¯ mihomo æœåŠ¡...${NC}"
        systemctl restart mihomo
        echo -e "${GREEN}æœåŠ¡å·²é‡å¯${NC}"
    fi
}

# ä¸»å‡½æ•°
main() {
    check_root
    
    case "$1" in
        add-sub)
            add_subscription "$2" "$3"
            ;;
        remove-sub)
            remove_subscription "$2"
            ;;
        list-subs)
            list_subscriptions
            ;;
        update-subs)
            echo -e "${YELLOW}è¯·ä½¿ç”¨ 'mihomo-update' å‘½ä»¤æ›´æ–°è®¢é˜…${NC}"
            ;;
        set-port)
            set_port "$2"
            ;;
        set-mixed-port)
            set_mixed_port "$2"
            ;;
        set-tproxy-port)
            set_tproxy_port "$2"
            ;;
        enable-tproxy)
            enable_tproxy
            ;;
        disable-tproxy)
            disable_tproxy
            ;;
        test)
            test_config
            ;;
        edit)
            edit_config
            ;;
        status)
            show_status
            ;;
        backup)
            backup_config
            ;;
        restore)
            restore_config "$2"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            show_help
            ;;
    esac
}

main "$@"
